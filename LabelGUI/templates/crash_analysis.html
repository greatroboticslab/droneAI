<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crash Analysis / Verification</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand__title">DroneAI</div>
      <div class="brand__subtitle">Crash Analysis & Verification</div>
    </div>

    <div class="nav-actions">
      <a class="btn btn--ghost" href="/">Home</a>
      <a class="btn btn--ghost" href="/validation_index">Validation</a>
      <a class="btn btn--ghost" href="/db_tools">DB Tools</a>
    </div>
  </div>
</header>

  <main class="container">
    <p class="muted">
      Reads <b>analysis/data/manifest.csv</b> and <b>analysis/results/per_video.csv</b>.
      Saves verification to SQLite (<b>db/droneai.sqlite</b>) and exports Excel to <b>analysis/results/crash_verification.xlsx</b>.
    </p>

    {% if not items or items|length == 0 %}
      <div class="card">
        <h3>No items found</h3>
        <p>Add at least one row in <code>analysis/data/manifest.csv</code> with columns:</p>
        <code>person,scenario,youtube_link</code>
      </div>
    {% else %}
      <div class="card" style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Person</th>
              <th>Scenario</th>
              <th>Pred crashes</th>
              <th>Pred/min</th>
              <th>Verified crashes</th>
              <th>Verified/min</th>
              <th>Link</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for e in items %}
              <tr>
                <td>
                  {% if e.verified %}
                    <span class="chip chip--ok">Verified</span>
                  {% else %}
                    <span class="chip chip--no">Not verified</span>
                  {% endif %}
                </td>
                <td><b>{{ e.person }}</b></td>
                <td>{{ e.scenario }}</td>
                <td>{{ e.pred_crashes }}</td>
                <td>{{ e.pred_per_min }}</td>
                <td>{{ e.ver_crashes }}</td>
                <td>{{ e.ver_per_min }}</td>
                <td class="truncate">
                  <a href="{{ e.youtube_link }}" target="_blank">{{ e.youtube_link }}</a>
                </td>
                <td>
                  <form method="POST" action="/crash_run" class="rowform">
                    <input type="hidden" name="row_id" value="{{ e.row_id }}">
                    <input type="hidden" name="person" value="{{ e.person }}">
                    <input type="hidden" name="scenario" value="{{ e.scenario }}">
                    <input type="hidden" name="youtube_link" value="{{ e.youtube_link }}">
                    <div>
                      <label>sample_fps</label>
                      <input name="sample_fps" value="{{ e.sample_fps }}">
                    </div>
                    <div>
                      <label>conf</label>
                      <input name="conf" value="{{ e.conf }}">
                    </div>
                    <button class="btn btn--primary" type="submit">Run + Verify</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <a class="btn btn--secondary" href="/crash_analysis">Refresh table</a>
        <a class="btn btn--primary" href="/crash_export_excel">Export Excel</a>
      </div>
    {% endif %}
  </main>
</body>
</html>
