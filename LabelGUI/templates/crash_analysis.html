<!DOCTYPE html>
<html>
<head>
  <title>Crash Analysis</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align:left; }
    th { background:#111827; color: #fff; position: sticky; top: 0; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.85em; }
    .ok { background:#d1fae5; color:#065f46; }
    .no { background:#fee2e2; color:#991b1b; }
    .btn { padding: 8px 12px; border: none; border-radius: 8px; cursor:pointer; }
    .primary { background:#2563eb; color:#fff; }
    .secondary { background:#e5e7eb; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: end; margin-top: 10px;}
    input { padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
    .small { font-size:0.9em; color:#555; }
    .truncate { max-width: 420px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
  </style>
</head>
<body>
<div class="container">
  <h1>Crash Analysis + Manual Verification</h1>
  <p class="small">
    This page reads <code>analysis/data/manifest.csv</code> and shows:
    <b>predicted</b> crash counts (from <code>analysis/results/per_video.csv</code>) and
    <b>verified</b> crash counts (from <code>analysis/results/verified.csv</code>).
  </p>

  {% if items and items|length > 0 %}
    <table>
      <tr>
        <th>Status</th>
        <th>Person</th>
        <th>Scenario</th>
        <th>Predicted crashes</th>
        <th>Pred / min</th>
        <th>Verified crashes</th>
        <th>Verified / min</th>
        <th>Link</th>
        <th>Action</th>
      </tr>
      {% for it in items %}
      <tr>
        <td>
          {% if it.verified %}
            <span class="pill ok">Verified</span>
          {% else %}
            <span class="pill no">Not verified</span>
          {% endif %}
        </td>
        <td>{{ it.person }}</td>
        <td>{{ it.scenario }}</td>
        <td>{{ it.pred_crash_events }}</td>
        <td>{{ it.pred_crashes_per_min }}</td>
        <td>{{ it.verified_crash_events }}</td>
        <td>{{ it.verified_crashes_per_min }}</td>
        <td class="truncate" title="{{ it.youtube_link }}">{{ it.youtube_link }}</td>
        <td>
          <form method="POST" action="/crash_run" style="margin:0;">
            <input type="hidden" name="person" value="{{ it.person }}">
            <input type="hidden" name="scenario" value="{{ it.scenario }}">
            <input type="hidden" name="youtube_link" value="{{ it.youtube_link }}">
            <div class="row" style="margin:0;">
              <div>
                <label class="small">sample_fps</label><br>
                <input name="sample_fps" value="2" style="width:80px;">
              </div>
              <div>
                <label class="small">conf</label><br>
                <input name="conf" value="0.5" style="width:80px;">
              </div>
              <div style="align-self:flex-end;">
                <button class="btn primary" type="submit">Run + Verify</button>
              </div>
            </div>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
  {% else %}
    <p>No entries found. Make sure you have <code>analysis/data/manifest.csv</code> with columns: person, scenario, youtube_link.</p>
  {% endif %}

  <br>
  <a href="/"><button class="btn secondary" type="button">Back to Home</button></a>
</div>
</body>
</html>
