<!DOCTYPE html>
<html>
<head>
  <title>Video Stream — Mark Events</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    #done-overlay {
      display: none;
      margin-top: 16px;
      padding: 16px;
      border-radius: 8px;
      background: #0f172a;
      border: 1px solid #22c55e;
      color: #e5e7eb;
    }
    #done-overlay h2 {
      margin-top: 0;
      color: #22c55e;
    }
    #done-buttons {
      margin-top: 12px;
    }
    #done-buttons button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Video Stream — Mark Events</h1>

  <!-- Video area -->
  <div>
    <img id="video-feed"
         src="{{ url_for('validation_video_feed') }}"
         alt="Video stream will appear here"
         style="width:100%; max-height:480px; object-fit:contain; border:1px solid #ccc;">
  </div>

  <p style="margin-top:6px; font-size:0.9em; color:#9ca3af;">
    If the video area is blank, the video may still be downloading from YouTube. Please wait a few seconds.
  </p>

  <!-- Playback controls -->
  <div style="margin-top: 10px;">
    <button id="rewind-btn">« Rewind 10s</button>
    <button id="pause-btn">Pause / Resume</button>
    <button id="forward-btn">Forward 10s »</button>
  </div>

  <hr>

  <!-- Event buttons -->
  <h2>Mark Events</h2>
  <div style="margin-bottom: 12px;">
    <button class="event-btn" data-event="takeoff">Mark Take-off</button>
    <button class="event-btn" data-event="land">Mark Land</button>
    <button class="event-btn" data-event="minor-crash">Mark Minor Crash</button>
    <button class="event-btn" data-event="severe-crash">Mark Severe Crash</button>
  </div>

  <p>Total Events Observed: <span id="event-count">0</span></p>

  <!-- End-of-session overlay -->
  <div id="done-overlay">
    <h2>Labeling Session Complete</h2>
    <p id="done-message">
      The video has finished and your labeled clips + log file are being saved
      into the ValidationResults folder.
    </p>
    <div id="done-buttons">
      {% if source == 'excel' %}
        <button type="button" onclick="window.location.href='{{ url_for('pick_from_excel') }}'">
          Label Another Video
        </button>
      {% endif %}
      <button type="button" onclick="window.location.href='{{ url_for('home_page') }}'">
        Back to Home
      </button>
    </div>
  </div>

  <br>
  <button type="button" onclick="window.location.href='{{ url_for('home_page') }}'">
    Back to Home
  </button>

  <div class="page-footer">
    Created by Ethan Stanks 2025.
    <a href="https://ethanstanks.github.io/" target="_blank">My Portfolio</a>
  </div>
</div>

<script>
  const eventButtons = document.querySelectorAll('.event-btn');
  const eventCountSpan = document.getElementById('event-count');
  const pauseBtn = document.getElementById('pause-btn');
  const rewindBtn = document.getElementById('rewind-btn');
  const forwardBtn = document.getElementById('forward-btn');
  const doneOverlay = document.getElementById('done-overlay');
  const doneMessage = document.getElementById('done-message');
  const sessionSource = "{{ source|default('manual') }}";

  let eventCount = 0;

  // Send event label
  eventButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const ev = btn.getAttribute('data-event');
      fetch('/mark_event', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({event: ev})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          eventCount += 1;
          eventCountSpan.textContent = eventCount;
        }
      })
      .catch(err => console.error('mark_event error:', err));
    });
  });

  // Playback buttons
  pauseBtn.addEventListener('click', () => {
    fetch('/toggle_pause', {method: 'POST'});
  });

  rewindBtn.addEventListener('click', () => {
    fetch('/rewind', {method: 'POST'});
  });

  forwardBtn.addEventListener('click', () => {
    fetch('/fast_forward', {method: 'POST'});
  });

  // Poll status so we know when the video is done
  function pollStatus() {
    fetch('/check_status')
      .then(r => r.text())
      .then(txt => {
        if (txt.trim() === 'done') {
          // Show completion overlay (clips may still be finishing in background)
          doneOverlay.style.display = 'block';
          if (sessionSource === 'excel') {
            doneMessage.textContent =
              'The video has finished. Your labeled clips and log file are being saved ' +
              'into this person\'s folder. You can now pick another video to label.';
          } else {
            doneMessage.textContent =
              'The video has finished. Your labeled clips and log file are being saved ' +
              'into the ValidationResults folder.';
          }
        } else {
          setTimeout(pollStatus, 2000);
        }
      })
      .catch(err => {
        console.error('check_status error:', err);
        setTimeout(pollStatus, 4000);
      });
  }
  pollStatus();
</script>
</body>
</html>
