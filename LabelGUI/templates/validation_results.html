<!DOCTYPE html>
<html>
<head>
    <title>Validation - Mark Events</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
      body { font-family: Arial, sans-serif; }
      .container { max-width: 900px; margin: 20px auto; padding: 10px; }
      #videoBox {
        width: 820px;
        padding: 10px;
        border: 2px dashed #999;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 150px;
        background: #fafafa;
      }
      #videoImg { display: block; max-width: 100%; height: auto; }
      #fallback { color:#a00; display:none; text-align:center; padding: 8px; }
      #downloading { color:#444; margin-bottom:8px; }
      .controls { margin: 8px 0; }
      .controls button { margin-right: 8px; padding: 8px 12px; }
      h2 { margin-top: 18px; }
      .event-buttons button { margin-right: 8px; padding: 10px 14px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Video Stream â€” Mark Events</h1>

    <div id="videoBox">
      <!-- MJPEG stream element -->
      <img id="videoImg" src="{{ url_for('validation_video_feed') }}" alt="Video stream (MJPEG)">
      <div id="fallback">No video stream available. The file may still be downloading or the stream failed. Check the server console for errors.</div>
    </div>

    <div id="downloading">If the video area is blank, the video may still be downloading from YouTube. Please wait a few seconds.</div>

    <!-- Playback controls -->
    <div class="controls">
      <button onclick="rewind()">&laquo; Rewind 10s</button>
      <button onclick="togglePause()">Pause / Resume</button>
      <button onclick="forward()">Forward 10s &raquo;</button>
    </div>

    <!-- Event buttons -->
    <h2>Mark Events</h2>
    <div class="event-buttons">
      <button onclick="markEvent('takeoff')">Mark Take-off</button>
      <button onclick="markEvent('land')">Mark Land</button>
      <button onclick="markEvent('minor-crash')">Mark Minor Crash</button>
      <button onclick="markEvent('severe-crash')">Mark Severe Crash</button>
    </div>

    <p style="margin-top:12px;">Total Events Observed: <span id="eventCount">0</span></p>

    <br>
    <a href="/"><button type="button">Back to Home</button></a>
</div>

<script>
/* Mark event via JSON POST */
function markEvent(eventType) {
    fetch('/mark_event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event: eventType })
    }).then(() => updateCount())
      .catch(e => console.error("mark_event failed:", e));
}

/* Update event count display */
function updateCount() {
    fetch('/get_crash_count')
        .then(r => r.text())
        .then(txt => { document.getElementById("eventCount").innerText = txt; })
        .catch(e => console.error("get_crash_count failed:", e));
}

/* Playback control helpers */
function rewind() { fetch('/rewind', { method: 'POST' }).catch(e=>console.error(e)); }
function forward() { fetch('/fast_forward', { method: 'POST' }).catch(e=>console.error(e)); }
function togglePause() { fetch('/toggle_pause', { method: 'POST' }).then(r => r.json()).then(d => console.log("pause toggled:", d)).catch(e=>console.error(e)); }

/* Show fallback message if image fails to load */
const videoImg = document.getElementById('videoImg');
const fallback = document.getElementById('fallback');
const downloadingNote = document.getElementById('downloading');

videoImg.addEventListener('error', () => {
  fallback.style.display = 'block';
});

/* Hide the "downloading" suggestion when frames appear */
let checkLoaded = setInterval(() => {
  try {
    if (videoImg && videoImg.naturalWidth > 0) {
      downloadingNote.style.display = 'none';
      fallback.style.display = 'none';
      clearInterval(checkLoaded);
    }
  } catch (e) {}
}, 800);

/* Periodically refresh the event count */
updateCount();
setInterval(updateCount, 2000);
</script>
</body>
</html>
