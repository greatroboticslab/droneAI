<!DOCTYPE html>
<html>
<head>
    <title>Video Stream — Mark Events</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .video-frame {
            width: 100%;
            max-height: 420px;
            object-fit: contain;
            background: #111827;
            border: 2px dashed #4b5563;
        }
        .controls-row {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .controls-row button {
            min-width: 130px;
        }
        .section-title {
            margin-top: 24px;
            font-size: 1.25rem;
            font-weight: 600;
        }
        #finishedArea {
            margin-top: 30px;
            padding: 16px 20px;
            border-radius: 8px;
            background: #0f172a;
            border: 1px solid #10b981;
        }
        #finishedArea h2 {
            color: #bbf7d0;
        }
        #statusMessage {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Video Stream — Mark Events</h1>

    <!-- LIVE LABELING AREA -->
    <div id="liveArea">
        <img id="videoStream"
             class="video-frame"
             src="{{ url_for('validation_video_feed') }}"
             alt="Video stream will appear here">

        <div id="statusMessage">
            If the video area is blank, the video may still be downloading from YouTube. Please wait a few seconds.
        </div>

        <div class="controls-row">
            <button type="button" onclick="rewind10()">« Rewind 10s</button>
            <button type="button" onclick="togglePause()">Pause / Resume</button>
            <button type="button" onclick="forward10()">Forward 10s »</button>
        </div>

        <h2 class="section-title">Mark Events</h2>
        <div class="controls-row">
            <button type="button" onclick="sendEvent('takeoff')">Mark Take-off</button>
            <button type="button" onclick="sendEvent('land')">Mark Land</button>
            <button type="button" onclick="sendEvent('minorcrash')">Mark Minor Crash</button>
            <button type="button" onclick="sendEvent('severecrash')">Mark Severe Crash</button>
        </div>

        <p style="margin-top: 16px;">
            <strong>Total Events Observed:</strong>
            <span id="eventCount">0</span>
        </p>

        <br>
        <a href="/"><button type="button">Back to Home</button></a>
    </div>

    <!-- FINISHED SUMMARY AREA (hidden until video is done) -->
    <div id="finishedArea" style="display:none;">
        <h2>Labeling Session Completed</h2>
        <p>
            Your labeled events and short video clips have been saved in the
            <code>ValidationResults</code> folder of this project, organized by participant and scenario.
        </p>
        <p>
            <strong>Total events this session:</strong>
            <span id="finalEventCount">0</span>
        </p>

        <div class="controls-row" style="margin-top: 16px;">
            <a href="/pick_from_excel">
                <button type="button">Label More Videos</button>
            </a>
            <a href="/">
                <button type="button">Back to Home</button>
            </a>
        </div>
    </div>
</div>

<script>
    let finished = false;

    function sendEvent(eventType) {
        fetch('/mark_event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event: eventType })
        }).then(() => {
            refreshEventCount();
        }).catch(err => console.error('mark_event error:', err));
    }

    function rewind10() {
        fetch('/rewind', { method: 'POST' });
    }

    function forward10() {
        fetch('/fast_forward', { method: 'POST' });
    }

    function togglePause() {
        fetch('/toggle_pause', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                console.log('paused:', data.paused);
            });
    }

    function refreshEventCount() {
        fetch('/get_crash_count')
            .then(r => r.text())
            .then(txt => {
                document.getElementById('eventCount').innerText = txt;
                if (finished) {
                    document.getElementById('finalEventCount').innerText = txt;
                }
            })
            .catch(err => console.error('get_crash_count error:', err));
    }

    function pollStatus() {
        if (finished) return;
        fetch('/check_status')
            .then(r => r.text())
            .then(status => {
                if (status === 'done') {
                    finished = true;
                    // One last refresh of event count
                    refreshEventCount();
                    // Swap live area for finished summary
                    document.getElementById('liveArea').style.display = 'none';
                    document.getElementById('finishedArea').style.display = 'block';
                }
            })
            .catch(err => console.error('check_status error:', err))
            .finally(() => {
                if (!finished) {
                    setTimeout(pollStatus, 2000);
                }
            });
    }

    // Start polling when page loads
    refreshEventCount();
    setTimeout(pollStatus, 2000);
</script>
</body>
</html>
