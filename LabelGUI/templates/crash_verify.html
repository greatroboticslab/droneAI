<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manual Crash Verification</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .grid { display:grid; grid-template-columns: 1.6fr 0.8fr; gap: 14px; align-items:start; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .kv { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .k { font-size: 12px; color: var(--muted); font-weight: 800; text-transform: uppercase; letter-spacing: .4px; }
    .v { font-size: 16px; font-weight: 900; }
    .video-wrap { display:flex; justify-content:center; padding: 10px; }
    img#video { width: 100%; max-width: 920px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); }
    textarea { width: 100%; min-height: 90px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__title">Manual Crash Verification</div>
      <div class="brand__subtitle">Click “Crash +1” each time you observe a crash. Then Finish & Save.</div>
    </div>
    <nav class="topbar__right">
      <a class="btn btn--ghost" href="/crash_analysis">Back to list</a>
      <a href="/crash_export_excel">Export Excel</a>

    </nav>
  </header>

  <main class="container">
    <div class="panel">
      <div class="kv">
        <div>
          <div class="k">Person</div>
          <div class="v">{{ sess.person }}</div>
        </div>
        <div>
          <div class="k">Scenario</div>
          <div class="v">{{ sess.scenario }}</div>
        </div>
        <div>
          <div class="k">Predicted crashes</div>
          <div class="v">{{ sess.pred_crash_events }}</div>
        </div>
        <div>
          <div class="k">Pred / min</div>
          <div class="v">{{ sess.pred_crashes_per_min }}</div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">
        Video link: <a href="{{ sess.youtube_link }}" target="_blank" style="color:#93c5fd;">{{ sess.youtube_link }}</a>
      </div>
    </div>

    <div style="height: 12px;"></div>

    <div class="grid">
      <div class="panel video-wrap">
        <img id="video" src="/crash_video_feed/{{ sid }}" alt="video stream">
      </div>

      <div class="panel">
        <div class="v" style="margin-bottom:8px;">Verified crashes: <span id="verified_count">0</span></div>
        <div class="muted">Verified / min: <span id="verified_per_min">0</span></div>
        <div class="muted">Status: <span id="status_text">Running</span></div>

        <div style="height: 12px;"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn--danger" onclick="markCrash()">Crash +1</button>
          <button class="btn btn--primary" onclick="finish()">Finish & Save</button>
        </div>

        <div style="height: 14px;"></div>

        <div class="k">Notes (optional)</div>
        <textarea id="notes" placeholder="e.g., missed small crashes, false positives, unclear sections..."></textarea>

        <p class="muted" id="save_msg" style="margin-top:10px;"></p>
      </div>
    </div>

    <script>
      async function markCrash() {
        await fetch('/crash_mark/{{ sid }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({})
        });
        await refreshStatus();
      }

      async function refreshStatus() {
        const r = await fetch('/crash_status/{{ sid }}');
        const j = await r.json();
        if (!j.ok) return;

        document.getElementById('verified_count').innerText = j.verified_crash_events;
        document.getElementById('verified_per_min').innerText = j.verified_crashes_per_min;

        if (j.saved) {
          document.getElementById('status_text').innerHTML = 'Saved ✅';
        } else if (j.done) {
          document.getElementById('status_text').innerText = 'Video ended — click “Finish & Save”.';
        } else {
          document.getElementById('status_text').innerText = 'Running';
        }
      }

      async function finish() {
        const notes = document.getElementById('notes').value || '';
        const form = new FormData();
        form.append('notes', notes);

        const r = await fetch('/crash_finish/{{ sid }}', { method:'POST', body: form });
        const j = await r.json();
        document.getElementById('save_msg').innerText = j.message || '';
        await refreshStatus();
      }

      setInterval(refreshStatus, 1000);
      refreshStatus();
    </script>
  </main>
</body>
</html>
